# 簡易設計書

<!--toc:start-->
- [簡易設計書](#簡易設計書)
  - [概要](#概要)
  - [画面仕様](#画面仕様)
    - [共通](#共通)
    - [リポジトリ検索画面](#リポジトリ検索画面)
    - [リポジトリ詳細画面](#リポジトリ詳細画面)
    - [ブックマーク画面](#ブックマーク画面)
  - [API 仕様](#api-仕様)
  - [エラーハンドリング](#エラーハンドリング)
  - [ドメイン/データモデル、エンティティ](#ドメインデータモデルエンティティ)
    - [ドメイン/データモデル](#ドメインデータモデル)
    - [エンティティ](#エンティティ)
  - [アーキテクチャ（層）](#アーキテクチャ層)
  - [ページネーション設計](#ページネーション設計)
  - [キャッシュ戦略](#キャッシュ戦略)
    - [HTTP キャッシュ戦略](#http-キャッシュ戦略)
    - [画像](#画像)
    - [ブックマーク](#ブックマーク)
  - [テスト戦略](#テスト戦略)
<!--toc:end-->

## 概要

- 目的: GitHub リポジトリ検索 → 詳細確認（開発者が「ワクワク」するリポジトリを見つける）
- 画面: 検索画面, 詳細画面, ブックマーク画面

## 画面仕様

### 共通

- アプリバーは表示しない
- ボトムバーを表示し、以下のタブを切り替え可能
  - 検索
  - ブックマーク
- エラー時
  - キャッシュされたデータを表示（存在する場合）
  - オフライン時、画面に表示するコンポーネントの一番上に「オフラインモード」の灰色のバナーを表示
  - その他のエラーは、画面に表示するコンポーネントの一番上に「通信エラー」の赤色のバナーを表示
  - バナーの下に、メッセージとリトライボタンを表示
    - ex. 最新のデータを取得できませんでした。リトライまたはスワイプで再試行できます。
- ローディングインジケータは、初期表示・リトライ・スワイプ時に表示される
- エラー時はリトライボタンとスワイプで再試行可能
- エラー発生時、キャッシュがあればキャッシュデータを表示
- 画面遷移時は直前の状態（検索結果や入力値など）を保持する

### リポジトリ検索画面

- ページの状態:
  - 一覧読み込み中（ローディング）
  - 空 結果0件
  - エラー（エラーメッセージを表示・スワイプでリトライ）
- 空文字の場合は人気リポジトリの一覧を表示
- 検索一覧はスクロール可能であり、ページネーションに対応（Paging 3 使用）
- アイテムをタップすると詳細画面へ遷移
- 検索入力バー
  - タップ時にキーボード表示・カーソル表示・文字入力可能
  - 入力後300msでAPI検索（`debounce` + `flatMapLatest`で実装)、エンターキー押下時は即時検索
- 検索結果
  - 検索結果は 検索入力バーの下に一覧でリポジトリのアイテムを表示
  - 各アイテムに表示する項目:
  - [非表示] リポジトリID（repoId）
    - [非表示] リポジトリのURL（html_url）
    - リポジトリ名 (owner/name)
    - [非表示] 説明（description）
    - オーナーアバター(avatar_url)
    - 主言語（language）
    - スター数 (stargazers_count)
    - [非表示] Watchers数 (watchers_count)
    - [非表示] Fork数 (forks_count)
    - [非表示] Issue数 (open_issues_count)
    - 最終更新日（updated_at）
    - ブックマークボタン（ローカル保存）
  - 検査キーワードに基づき GitHub 検索 API を呼び出し、結果をページネーションで取得
    - sort=stars（スター数順）
    - order=desc（降順）
  - 検索キーワードが空文字の場合はstar数1万以上の人気リポジトリを降順で表示
    - q=stars:>10000（スター数1万以上の人気リポジトリ）
    - sort=stars（スター数順）
    - order=desc（降順）
  - 検索結果が0件の場合は「キーワードに一致するリポジトリが見つかりませんでした。」と表示
  - スクロールでページネーション（次ページ自動読込）
- ブックマークボタン
  - 未登録時タップで登録、登録済み時タップで解除
  - ボタン状態は即時反映
  - ブックマーク情報はローカルDB（Room）に保存・削除される
  - DBアクセスエラー時は何もしない
- リトライ
  - エラー時にリトライボタン表示、タップまたはスワイプで再試行
  - リトライ成功時はエラー表示が消える
  - 失敗時はエラー表示が残る
- ローディング
  - 初期表示・リトライ・スワイプ時にローディングインジケータ表示

### リポジトリ詳細画面

- 画面左上に戻るボタンを表示し、タップで検索画面へ戻る
- 検索画面でタップしたアイテムをカードで表示
  - カードに表示する項目:
    - [非表示] リポジトリID（repoId）
    - [非表示] リポジトリのURL（html_url）
    - リポジトリ名 (owner/name)
    - 説明（description）
    - オーナーアバター(avatar_url)
    - 主言語（language）
    - スター数 (stargazers_count)
    - Watchers数 (watchers_count)
    - Fork数 (forks_count)
    - Issue数 (open_issues_count)
    - 最終更新日（updated_at）
    - ブックマークボタン（ローカル保存）
  - カードをタップすると GitHub のリポジトリページへ遷移（外部ブラウザ表示）
    - リポジトリURLが存在すれば外部ブラウザで開く
    - URLが不正・存在しない場合はNot Foundページを開く
- 戻るボタン
  - 検索画面またはブックマーク画面から遷移した場合、それぞれ元の画面に戻る
  - 戻った際、検索結果やブックマーク一覧の状態は遷移前と変わらない
- ブックマークボタン
  - 登録済みの場合は解除確認ダイアログを表示
    - 「削除」タップで解除・一覧から削除・ダイアログ閉じる
    - 「キャンセル」タップでダイアログ閉じる
  - ブックマーク情報はローカルDB（Room）に保存 ・削除される

### ブックマーク画面

- ブックマーク済みリポジトリの一覧を表示
  - ブックマーク情報はローカルDB（Room）から取得する
  - ブックマークが0件の場合は「ブックマークが存在しません」と表示
  - 一覧アイテムをタップでリポジトリ詳細画面へ遷移
- 一覧はリポジトリ検索画面と同様の情報を表示
- ブックマーク解除は詳細画面と同じダイアログ仕様

## API 仕様

GraphQL を使う案もあるが学習コストと導入コストを考慮し REST を採用

GitHub REST Search API:

```
GET https://api.github.com/search/repositories?q={query}&page={page}&per_page={per_page}
```

認証ヘッダ:

```
Authorization: token <GITHUB_TOKEN>`
```

シークレットは `local.properties` に保存し、`.gitignore` に追加

## エラーハンドリング

ROP（Railway Oriented Programming）を採用し、各層でのエラーハンドリングを明確化

- ドメイン層: ビジネスロジックに関するエラー
  - 今回は特に想定しない
- データ層: ネットワークエラー、データベースエラー
  - ネットワークエラー
    - APIレスポンス不正、APIレートリミット超過など:
      - ResponseException→`ApiErr.Unexpected`
    - ネットワークエラー:
      - IOException→`ApiErr.Offline`
  - データベースエラー
    - RoomDatabaseException→`DbErr`
  
各層で`runCatching`を使い、例外をキャッチして適切なエラー型に変換し、kotlin-resultの`Result`型で返す

※ 今回はドメイン層でのエラーは特に想定しないため、データ層でのエラー処理に注力

## ドメイン/データモデル、エンティティ

### ドメイン/データモデル

- `Repo`
  - リポジトリID（repoId: Long）
  - リポジトリ名（repoName: String）
  - 説明（description: String?）
  - 主言語（language: String?）
  - スター数（stargazersCount: Int）
  - ウォッチャー数（watchersCount: Int）
  - フォーク数（forksCount: Int）
  - イシュー数（openIssuesCount: Int）
  - オーナー（RepoOwner { ownerName: String, avatarUrl: String }）
  - リポジトリURL（htmlUrl: String）
  - 最終更新日（updatedAt: String）

### エンティティ

- `RepoEntity`
  - 上記ドメインモデルに加え、ブックマーク状態（isBookmarked: Boolean）

## アーキテクチャ（層）

MVI + Clean-ish 層構成

```
UI (Compose) <-> ViewModel <-> UseCase <-> Repository <-> Remote (Ktor) + Local (Room)
```

## ページネーション設計

- Paging 3 を使い `PagingSource` 内で API呼び出し を行う
- 1ページあたりの件数: 30
- 初回ロード時: 60（2ページ分）
- プリフェッチ件数（追加ロードを開始する残り件数）: 10

## キャッシュ戦略

### HTTP キャッシュ戦略

短期的なmax-ageキャッシュとETag条件付きリクエストの組み合わせで行う

- **Cache-Control: max-age=30-60** : スクロール中のスムーズな体験のため

- **ETag**: コンテンツ更新時の効率的な検証のため

ktorのOkHttpエンジンを使用し、上記のキャッシュ戦略を実装

### 画像

Coilによる自動キャッシュ

クラッシュやパフォーマンス低下が見られた場合は、端末ごとのメモリ量・画像数・解像度を変更して調節

## 永続化

### ブックマーク


ブックマークはアプリ終了後も保持する必要があるため、Room に永続化

## テスト戦略

テストコード導入は最小限に留め、手動テストをメインに実施する

以下のようなコードでのテスト導入のメリットが後々の保守性・管理のデメリットを踏まえても上回る場合に限り、テストコードを追加実装する

- API未実装時のモック検証
- マイグレーションやデータ変換のような目視困難な検証
- 手動では困難な境界値・大量データ・非同期処理

作成したテストケースについては以下をご参照ください。

- [GitSeekアプリ・テストケース](./GitSeekアプリ・テストケース.xlsx)
